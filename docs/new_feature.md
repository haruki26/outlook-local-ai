# 意味拡張検索機能 仕様書  

Version: 1.0  
Last Updated: 2025-12-02  
Target: Outlook Add-in（メール検索支援ツール）  
Model: ruri v3 70M  
Embedding: 既存のベクトルストア（CosmosDB or Chroma 等）

## 1. 概要

本機能は、ユーザーが入力した検索語に対して、  
**埋め込みベクトル空間上の類似方向から抽出される“関連概念”を自動補完し、  
より広く、正確に意味的なメール検索を行う**ための検索拡張機能である。

また、検索結果ごとに  
**「なぜこのメールがヒットしたのか」  
「どの概念方向が強く働いたのか」**  
を1行で説明し、ユーザーの理解を補助する。

本機能は生成系 LLM を一切使用せず、  
**ruri v3 70M の埋め込み（embedding）機能のみで完結する**。

## 2. 目的

- 単語一致・フリーワード検索では拾えない  
  **意味的に近いメールをヒットさせる**
- 検索語が曖昧でも  
  **関連する概念方向を自動補完し、検索漏れを防ぐ**
- Add-in の制約（自動メール取り込み不可、処理速度）を満たしつつ  
  **AI 検索の価値を最大限発揮する**

## 3. 機能一覧

### 3.1 拡張検索（Semantic Expansion Search）

#### 機能説明
ユーザー入力の検索語を embedding し、  
**近い方向の概念軸（関連ワード）をベクトル空間から自動抽出**して  
検索クエリを拡張する。

#### 主な処理
1. ユーザーの検索語を embedding ベクトル化  
2. 事前計算済み「概念ベクトル集合」を k 個取得  
3. 類似度が高い上位 n 個を「関連概念」として抽出  
4. 検索時に以下のいずれかの方法で結果拡張  
   - (A) `ユーザーベクトル + 重み付けされた関連概念ベクトル` を新しい検索ベクトルにする  
   - (B) 関連概念を OR 条件の拡張ベクトルとして扱う  

### 3.2 関連概念チップ表示（UI Feedback）

検索結果の上部に関連概念を表示。

例：
```
関連概念: [ 支払い ] [ 見積 ] [ 取引条件 ] [ 請求期限 ]
```

#### 目的
- ユーザーに「検索補完が働いた」ことを明示  
- 自分の入力以外の意味軸を理解しやすくする  
- （任意）チップをクリックすることで  
  その概念方向を強調して再検索ができる

### 3.3 ヒット理由表示（Per-result Explanation）

各検索結果に “1行の説明” を表示する。

例：
```
理由: 「見積」「支払い」に意味的に近いためヒットしました
```

#### 生成方法
- 関連概念の上位 1〜3 個を文章テンプレに差し込んで生成  
- テキスト生成は行わない  
- テンプレ例：
  - 「『{X}』『{Y}』に意味的に近いためヒットしました」
  - 「『{X}』周辺の概念方向として検索されました」

## 4. UI 仕様

### 4.1 検索画面レイアウト（文章ワイヤーフレーム）

```
+---------------------------------------------+
| 検索バー   [ {検索語} ] 🔍                   |
+---------------------------------------------+

🔍 あなたの検索語に近い概念も含めて検索しました

関連概念：
[ 概念1 ] [ 概念2 ] [ 概念3 ] [ 概念4 ]

---

📧 件名：{メールタイトル}
　概要：{本文サマリ}
　理由：{ヒット理由の1行説明}
----------------

📧 件名：{メールタイトル}
　概要：{本文サマリ}
　理由：{ヒット理由の1行説明}
----------------

...
```

## 5. データ構造

### 5.1 概念ベクトル（Concept Vector）

| フィールド | 型 | 説明 |
|-----------|------|------|
| concept_id | string | 固有ID |
| label | string | UI表示用ラベル |
| embedding | float[] | 概念ベクトル |
| created_at | datetime | 作成日時 |

#### 特徴
- 概念ラベルは定義済み（例：支払い/見積/契約/報告/トラブル/依頼/営業など）  
- embedding は各ラベルを ruri で埋め込んで生成しておく  
- Add-in ではオンラインストアから取得して利用  

## 6. 処理フロー（検索時）

### 6.1 全体フロー

1. **ユーザーが検索語を入力**
2. 検索語を ruri embedding に変換
3. 概念ベクトル集合との cosine 類似度を計算
4. 上位 n 個（推奨 3〜5）の概念を選出
5. 新しい検索ベクトルを形成（加重平均 or ベクトルセット）
6. ベクトルDBにクエリを投げる
7. 得られた結果に対して  
   - 概念チップを表示  
   - 各メールにヒット理由を生成  
8. 検索結果画面へ表示

## 7. パフォーマンス要件

- ruri embedding は 70M で軽量のため  
  **Add-in 実行環境（ローカルマシン）で 50–150ms 程度**で生成可能  

## 8. 制約条件（Add-in 仕様として重要）

- Add-in では**勝手にメール取得・自動取り込みは不可**  
- 検索対象のメールは「ユーザーが自分で明示的に追加したもののみ」  
- LLM 生成不可（生成性が強い処理はパフォーマンス問題がある）  
- すべて**embedding 操作だけで完結**させること
