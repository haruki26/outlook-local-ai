# メール分割サイズ調査ログ (2025-12-03)

## 1. 現状把握
- `server/app/services/ai/rag/splitter.py` で `RecursiveCharacterTextSplitter` を使用。
- 既定値: `chunk_size=512` 文字、`chunk_overlap=102` 文字 (20%)。改行優先で段落ごとに分割。
- `VectorMail.from_pure_mail` でこの splitter を通した結果を `section_id` 単位で登録。Tag フィルタは metadata に含めている。

## 2. 要件整理
- Semantic Expansion では「請求/契約/進捗/障害/会議」といった概念との類似度で検索するため、段落レベルで意味が完結していることが重要。
- Outlook 既存機能が全文検索や固有名詞検索を担保しているため、本機能では「意味まとまりを失わずに embedding を作る」ことが優先。
- 平均的な業務メールで 1 段落 200〜350 文字（日本語）のケースが多く、複数段落を 1 チャンクにまとめても 600 文字程度で収まることが多い。

## 3. チャンクサイズ候補と評価
| チャンク長 | 長所 | 短所 | 想定用途 |
|-------------|------|------|----------|
| 256 文字 / overlap 50 | フレーズ粒度で高精度マッチ。短文メールでノイズが少ない。 | 複数文書に跨る概念（例: 請求→支払期日）が分断される。メール全体の意図が失われやすい。 | チケット/アラートなどブリーフなメール。
| **450〜600 文字 / overlap 90〜120** | 2–3 段落を保持でき、概念間の関係を壊さない。embedding 入力長（ruri v3 70M: ~2K トークン）に十分余裕。 | 長大メールではまだ分割が必要。微細な表現（固有名詞検索など）は別機能に任せる必要あり。 | **Semantic Expansion目的の標準設定として推奨。**
| 800+ 文字 / overlap 160+ | メール全体文脈を保持できる。 | ベクトルサイズが大きくなり検索精度が低下。Chroma への登録/検索が重くなる。 | 長文レポートや議事録向けだが、Add-in では扱わない想定。

## 4. 推奨設定
- `chunk_size=480`〜`560` 文字、`chunk_overlap=100` 前後をベースとする。
  - ほとんどの業務メールで「1 チャンク = 2 段落」程度になり、請求条件や会議アジェンダなど意味的に関連する文が同一 embedding に入る。
  - Japanese 文字数 500 ≒ 230–260 tokens 相当で、embedding モデルのキャパシティから見ても妥当。
- オーバーラップは 20% を維持し、段落を跨ぐ情報（例: 支払期日が後段に記載）も検索対象に含める。
- 特殊ケース（非常に短いメールや定型システム通知）は、一定以下の長さ（例: 200 文字）であれば分割せず 1 チャンク化する条件を追加検討。

## 5. 次のアクション
1. `splitter.py` の既定値を 480/100 に調整する案を試験環境で検証（既存データを再分割して Chroma に再投入）。
2. 代表的な 10 通程度でチャンク結果を比較し、請求/契約/会議といった概念の抽出精度をヒューリスティックに確認。
3. チャンクサイズ変更後の Chroma 再構築にかかる時間とストレージを測定し、Phase2 設計資料にフィードバック。
